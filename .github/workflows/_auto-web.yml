# 示例打包并发布 React 应用的工作流文件
name: React Build, Release And Release [my-web] # [*]

on:
  workflow_dispatch:
  push:
    tags:
      # - 'v*'
      - 'none' # 临时禁用此工作流触发，避免误发布

# ==== 变量修改 开始 ====
env:
  APP_NAME: my-web # [*] 基础名称
  WORKING_DIRECTORY: ./web # [*] package.json 所在的位置
  REMOTE_WORKDIR: /srv/app/my-web # [*] 远程部署目录
  CHECK_SYSTEMD: false # [*] 是否检查 systemd 服务状态，true 或 false
# ==== 变量修改 结束 ====

permissions:
  contents: write

jobs:
  build-and-release:
    # [!] 拼接
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境 (npm)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'

      # 3. 安装依赖并构建项目 (npm)
      - name: Build project
        env:
            VITE_API_URL: ${{ vars.VITE_API_URL }} # [*] 设置构建时的环境变量（github action varibles）
        run: |
          npm ci
          npm run build
        working-directory: ${{ env.WORKING_DIRECTORY }}

      # 4. 将构建产物打包成压缩文件
      - name: Package artifact
        run: |
          # dist 目录是从 WORKING_DIRECTORY 内部生成的
          # 所以打包时要先进入 WORKING_DIRECTORY
          cd ${{ env.WORKING_DIRECTORY }}
          tar -zcvf ../${{ env.APP_NAME }}-${{ github.ref_name }}.tar.gz dist

      # 5. 创建 / 更新 Release 并上传构建产物（使用 gh，避免 already_exists 422）
      - name: Create or update GitHub Release and upload artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          ASSET="${APP_NAME}-${TAG}.tar.gz"

          echo "Using tag: $TAG"
          echo "Asset file: $ASSET"

          # 1) 如果 Release 不存在，就尝试创建
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG not found, trying to create..."
            if ! gh release create "$TAG" \
              --title "$TAG" \
              --notes "" >/dev/null 2>&1; then
              echo "Release create failed (maybe already exists), continue anyway..."
            fi
          else
            echo "Release $TAG already exists, will just upload asset."
          fi

          # 2) 上传 / 覆盖 当前 workflow 产出的构建包
          gh release upload "$TAG" "$ASSET" --clobber
  deploy:
    needs: build-and-release   # ★ 关键：先构建再部署
    # [!] 拼接
    if: ${{ always() && (needs.build-and-release.result == 'success' || github.event_name == 'workflow_dispatch') }}
    runs-on: ubuntu-latest

    steps:
      - name: Show deploy info
        run: |
          echo "APP_NAME      : ${{ env.APP_NAME }}"
          echo "REMOTE_WORKDIR: ${{ env.REMOTE_WORKDIR }}"
          echo "github.ref     : ${{ github.ref }}"
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "NOTE: 请在 'Use workflow from' 中选择要部署的 tag."

      - name: Deploy via godeploy on remote host
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }} # [*]
          username: ${{ secrets.SSH_USER || 'root' }}   # 默认 root
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}         # 默认 22
          command_timeout: 30m
          script: |
            set -euo pipefail

            APP_NAME="${{ env.APP_NAME }}"
            REMOTE_WORKDIR="${{ env.REMOTE_WORKDIR }}"
            TARGET_TAG="${{ github.ref_name }}"              # 你在 UI 中选择的 tag
            SYSTEMD_UNIT="${APP_NAME}.service"
            CHECK_SYSTEMD="${{ env.CHECK_SYSTEMD }}"

            echo "===> Host: $(hostname)"
            echo "===> APP_NAME      : ${APP_NAME}"
            echo "===> REMOTE_WORKDIR: ${REMOTE_WORKDIR}"
            echo "===> TARGET_TAG    : ${TARGET_TAG}"
            echo "===> SYSTEMD_UNIT  : ${SYSTEMD_UNIT}"
            echo

            # 1) 检查 godeploy 是否存在
            if ! command -v godeploy >/dev/null 2>&1; then
              echo "[ERROR] godeploy not found on remote host."
              echo "        请先在服务器上安装 godeploy 再运行此 workflow。"
              echo "        例如: curl -fsSL https://raw.githubusercontent.com/terobox/godeploy/main/install.sh | sudo bash"
              exit 1
            fi
            echo "[INFO] godeploy found: $(command -v godeploy)"
            godeploy --version || true
            echo

            # 2) 检查工作目录
            if [ ! -d "${REMOTE_WORKDIR}" ]; then
              echo "[ERROR] Remote workdir not found: ${REMOTE_WORKDIR}"
              exit 1
            fi
            cd "${REMOTE_WORKDIR}"

            # 3) 检查 godeploy.env 是否存在
            if [ ! -f "./godeploy.env" ]; then
              echo "[ERROR] ./godeploy.env not found in ${REMOTE_WORKDIR}"
              echo "        请先在服务器上执行: cd ${REMOTE_WORKDIR} && godeploy init 并配置 REPO/APP_NAME 等。"
              exit 1
            fi

            echo "[INFO] Using godeploy.env in $(pwd)/godeploy.env"
            echo

            # 4) 执行 godeploy <tag>，version 全部由 CLI 决定
            echo "===> Running godeploy ${TARGET_TAG} ..."
            godeploy "${TARGET_TAG}"

            # === 新增开关 START ===
            if [ "${CHECK_SYSTEMD}" = "true" ]; then
              echo
              echo "===> Checking systemd unit status: ${SYSTEMD_UNIT}"

              if ! sudo systemctl is-active --quiet "${SYSTEMD_UNIT}"; then
                echo "[ERROR] systemd unit is not active: ${SYSTEMD_UNIT}"
                sudo systemctl status "${SYSTEMD_UNIT}" --no-pager -l || true
                exit 1
              fi

              sudo systemctl status "${SYSTEMD_UNIT}" --no-pager -l | head -n 30 || true
            else
              echo "[INFO] CHECK_SYSTEMD=false, skip systemd status check."
            fi
            # === 新增开关 END ===

            echo
            echo "[SUCCESS] ${APP_NAME} (${SYSTEMD_UNIT}) deployed with tag ${TARGET_TAG}."
